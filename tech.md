. Обзор приложения и цели: Создание Фундамента Устойчивости
1.1. Название продукта
Go High-Performance Proxy Load Balancer (Internal/Curriculum Edition)
1.2. Описание и Видение
Данный документ описывает требования к разработке высокопроизводительного обратного прокси-сервера (Reverse Proxy), который будет реализован на языке Golang, используя его нативные сетевые возможности для достижения максимальной скорости обработки трафика. Сердцем системы является балансировщик нагрузки, основанный на усовершенствованном алгоритме Smooth Round Robin (SRR), способном учитывать пропускную способность отдельных бэкенд-серверов через механизм весов.
Помимо основной задачи распределения запросов, продукт будет выступать в роли защитного шлюза, внедряя проверки здоровья (Health Checks), In-Memory кэширование для снижения задержек, а также современные методы управления трафиком, такие как Rate Limiting и SSL Termination.
1.3. Бизнес-Цели (Ключевые Метрики Успеха)
Успешная реализация этого проекта будет оценена по следующим критериям, демонстрирующим зрелость инженерного подхода:
Высокая Доступность (HA) и Отказоустойчивость: Система должна автономно реагировать на падение бэкенд-серверов (Health Check) и немедленно перенаправлять трафик на оставшиеся здоровые узлы, не требуя ручного вмешательства.
Повышение Производительности и Эффективности: Эффективное распределение нагрузки через SRR должно демонстрировать предсказуемое и равномерное использование ресурсов бэкенд-фермы. Добавление In-Memory Кэша призвано значительно снизить общую задержку для пользователей (Latency) при повторных запросах.
Демонстрация Современных Практик Безопасности: Внедрение SSL Termination показывает способность прокси обрабатывать зашифрованный трафик, а Rate Limiting демонстрирует механизмы защиты от несанкционированных всплесков нагрузки.
2. Целевая Аудитория: Инженеры-Практики
Основная аудитория — это системные администраторы и разработчики, ответственные за развертывание, мониторинг и поддержку внутренних или тестовых микросервисов. Они ценят:
Надежность: Чтобы сервис не падал из-за одного сбоящего компонента.
Конфигурируемость: Возможность быстро адаптировать ротацию серверов через простой YAML-файл.
Прозрачность: Четкие и структурированные логи для быстрой диагностики проблем.
3. Основные Функции и Функциональность: Детализация Требований
3.1. Core Networking (Проксирование HTTP/HTTPS)
Мы фокусируемся на Layer 7 (Прикладной уровень) для возможности инспекции запросов:
Протоколы: Полная поддержка входящего HTTPS (через SSL Termination) и исходящего HTTP/HTTPS к бэкендам.
Алгоритм Балансировки (SRR): Алгоритм Smooth Round Robin будет точно рассчитывать "текущий вес" каждого бэкенда на основе его изначального веса, обеспечивая более гладкое и справедливое распределение запросов по сравнению с Simple Round Robin, особенно когда веса сильно различаются.
3.2. Отказоустойчивость (Health Checks)
Система Health Check критически важна для обеспечения HA:
Проверка: Асинхронный воркер будет периодически (каждые 5 секунд) отправлять HTTP GET запрос на /healthz.
Исключение: Если 3 запроса подряд не вернули 200 OK (или превысили таймаут), узел немедленно удаляется из ротации SRR.
Восстановление: Неактивные узлы не будут нагружаться, но будут проверяться каждые 15 секунд. При успехе они автоматически возвращаются в пул.
3.3. Производительность (In-Memory Caching)
Для снижения нагрузки на бэкенды и улучшения отклика:
Механизм: Будет использоваться структура данных, защищенная sync.RWMutex, что позволит множеству горутин читать из кэша одновременно, не блокируя друг друга.
Политика: Статический TTL в 60 секунд будет применяться ко всем успешным GET-ответам. Это упрощает реализацию, но требует в будущем интеграции с заголовками Cache-Control.
3.4. Безопасность и Управление Трафиком (Защита Шлюза)
SSL Termination: Прокси берет на себя полную ответственность за TLS-рукопожатие с клиентом, используя предоставленные сертификат и ключ. После расшифровки прокси применяет все свои правила (SRR, Кэширование, Rate Limiting).
Rate Limiting (Token Bucket): Мы будем отслеживать трафик, исходящий от каждого уникального IP-адреса клиента. Если клиент превышает лимит в 600 запросов в минуту, ему возвращается HTTP 429.
4. Концептуальная Модель Данных (Конфигурация YAML)
(Таблица остается без изменений, так как она является точным и лаконичным техническим определением.)
5. Рекомендации по Техническому Стеку: Обоснование Выбора
Выбор Golang продиктован его превосходной нативной поддержкой конкурентности (Goroutines) и эффективной обработкой сетевых операций, что критично для прокси-сервера.
Компонент	Технология	Обоснование
Язык	Golang	Скорость компиляции, эффективность в I/O-связанных задачах, модель конкурентности.
Конфигурация	YAML	Человекочитаемость — это преимущество при отладке и ручной настройке.
Логирование	zap	Необходимость логировать очень много событий без значительного замедления работы основного цикла проксирования.
Кэширование	map + sync.RWMutex	Предсказуемая производительность. RWMutex гарантирует, что десятки одновременных запросов могут читать кэш в один и тот же момент времени без блокировки, что является идеальной моделью для кэширования.
Rate Limiting	Внешняя библиотека (go-rate или аналоги)	Алгоритм Token Bucket требует точного управления состоянием во времени. Использование проверенной библиотеки минимизирует риски, связанные с некорректной реализацией таймеров и учета токенов.
6. Принципы UI-дизайна (Консольный Вывод): Прозрачность Операций
Поскольку у нас нет графического интерфейса, консоль — это наш единственный канал связи с оператором:
Структурированность: Использование zap позволит оператору легко фильтровать логи по уровню (INFO, WARN, ERROR) или по определенному сервису (если это расширится).
Критическое Оповещение: Любое изменение состояния Health Check (Node UP/DOWN) должно сопровождаться четким WARN или ERROR сообщением.
Прозрачность Балансировки: При проксировании полезно видеть, какой именно узел был выбран (например, [SRR] Request routed to Backend 192.168.1.10:8000 (Weight 10)).
7. Соображения по Безопасности
Помимо Rate Limiting, критическим аспектом является обработка сбоев:
SSL Context: При загрузке ключа и сертификата (TLS) необходимо предусмотреть строгую проверку их существования и валидности. Если файлы не найдены, запуск должен быть прерван с уровнем FATAL.
Failover на Сбой: Если все бэкенды объявлены неактивными (Health Checks провалились для всех), прокси не должен зависать. Он должен немедленно отвечать клиен